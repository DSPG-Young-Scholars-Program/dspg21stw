---
title: "HT_network_analysis"
author: "Haleigh Tomlin"
date: "7/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(igraph)
library(network)
library(readxl)
library(tidyr)
library(tidyverse)
```


```{r}
#Color Blind Palettes

#color blind palette with grey

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#color blind palette with black

cbPalette.blk<-c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#display the palette

wheel <- function(col, radius = 1, ...)

  pie(rep(1, length(col)), col = col, radius = radius, ...)

wheel(cbPalette)
wheel(cbPalette.blk)
```


## Making the overall network data and its attributes

```{r}
cert <- read_xlsx("ONET_SOC_credentials.xlsx")
stw_change_pct <- read_xlsx("STW_2021_Change.xlsx")
```

```{r}
cert <- cert[-1]
```

```{r}
stw_change_pct <- stw_change_pct %>% select(SOC, GROWTH, PER_CHG, SOCNAME = NAME)
```

```{r}
cert <- cert %>% select(SOC, Certification.Name, Certifying.Organization, Type)
```

```{r}
d <- cert %>% left_join(stw_change_pct, by = "SOC")
```

```{r}
d
```

```{r}
d <- d %>% select(SOCNAME, Certification.Name, SOC, Certifying.Organization, Type, GROWTH, PER_CHG)
```

```{r}
d
```
soc_type <- substr(netmat[,2], start = 1, stop = 2)
```{r}
d <- d %>% mutate(SOC_type = substr(SOC, start = 1, stop = 2))
```

```{r}
unique((d %>% select(SOC, SOC_type, SOCNAME) %>% filter(SOC_type == "53"))$SOCNAME) 
```

```{r}
length(unique(d$SOC_type))
unique(d$SOC_type)
```

o 11-Management Occupations

o 13- Business and Financial Operations Occupations

o 15-Computer and Mathematical Occupations

o 17- Architecture and Engineering Occupations

o 19- Life, Physical, and Social Science Occupations

o 27-Art, Design, Entertainment, Sports, And Media Occupations

o 29-Healthcare Practitioners and Technical Occupations

o 35-Protective Service Occupations

o 43-Office and Administrative Support Occupations

o 45-Farming, Fishing, and Forestry Occupations

o 47-Construction and Extraction Occupations

o 49-Installation, Maintenance, and Repair Occupations

o 51-Production Occupations

o 53- Transportation and Material Moving Occupations

```{r}
d <- d %>% mutate(soc_type_name = case_when(SOC_type == "11" ~ "Management Occupations",
                                            SOC_type == "13" ~ "Business and Financial Operations Occupations",
                                            SOC_type == "15" ~ "Computer and Mathematical Occupations",
                                            SOC_type == "17" ~ "Architecture and Engineering Occupation",
                                            SOC_type == "19" ~ "Life, Physical, and Social Science Occupations",
                                            SOC_type == "27" ~ "Art, Design, Entertainment, Sports, And Media Occupations",
                                            SOC_type == "29" ~ "Healthcare Practitioners and Technical Occupation",
                                            SOC_type == "35" ~ "Protective Service Occupations",
                                            SOC_type == "43" ~ "Office and Administrative Support Occupations",
                                            SOC_type == "45" ~ "Farming, Fishing, and Forestry Occupations",
                                            SOC_type == "47" ~ "Construction and Extraction Occupations",
                                            SOC_type == "49" ~ "Installation, Maintenance, and Repair Occupations",
                                            SOC_type == "51" ~ "Production Occupations",
                                            SOC_type == "53" ~ "Transportation and Material Moving Occupations"))
```

```{r}
d
```


^^ use this as the original df.  An attributes matrix now:

```{r}
d_attributes1 <- d %>% select(name = SOCNAME, SOC, SOC_type, Certifying.Organization, Type, GROWTH, PER_CHG)
d_attributes2 <- d %>% select(name = Certification.Name, SOC, SOC_type, Certifying.Organization, Type, GROWTH, PER_CHG)
```

```{r}
d_attributes1 <- d_attributes1[!duplicated(d_attributes1$name),]
d_attributes2 <- d_attributes2[!duplicated(d_attributes2$name),]
```

```{r}
d_attributes <- rbind(d_attributes1, d_attributes2)
```

```{r}
d_attributes
```

```{r}
d <- d[!duplicated(d),]
```


```{r}
stw_network <- graph.data.frame(d, directed = F, vertices = d_attributes)
V(stw_network)$type <- bipartite.mapping(stw_network)$type
stw_network.pr <- bipartite.projection(stw_network)
```

## Cybersecurity Only

```{r}
cyber <- read_xlsx("Cyber.xlsx")
```

```{r}
cybermat_attributes1 <- cyber %>% select(name = ONETSOCTITLE, STW, Level, InDemand)
cybermat_attributes2 <- cyber %>% select(name = Certification, STW, Level, InDemand)
cybermat_attributes1 <- cybermat_attributes1[!duplicated(cybermat_attributes1$name),]
cybermat_attributes2 <- cybermat_attributes2[!duplicated(cybermat_attributes2$name),]
cybermat_attributes <- rbind(cybermat_attributes1, cybermat_attributes2)
cybermat_attributes <- cybermat_attributes[!duplicated(cybermat_attributes$name),]

cybermat_attributes <- cybermat_attributes %>% mutate(socname = case_when(name == "Forensic Science Technicians" ~ "Forensic\nScience\nTechnicians",
                                                                          name == "Network and Computer Systems Administrators" ~ "Network\nand Computer\nSystems\nAdministrators",
                                                                          name == "Information Security Analysts" ~ "Information\nSecurity\nAnalysts",
                                                                          name == "Computer Systems Analysts" ~ "Computer\nSystems\nAnalysts",
                                                                          name == "Software Developer" ~ "Software\nDeveloper",
                                                                          name == "Software Quality Assurance Analysts and Testers"~ "Software\nQuality\nAssurance\nAnalysts\nand Testers",
                                                                          name == "Computer Programmers" ~ "Computer\nProgrammers",
                                                                          name == "Information Technology Project Managers" ~ "Information\nTechnology\nProject\nManagers",
                                                                          name == "Computer and Information Systems Managers" ~ "Computer\nand\nInformation\nSystems\nManagers",
                                                                          name == "Computer User Support Specialists" ~ "Computer\nUser\nSupport\nSpecialists",
                                                                          name == "Computer Network Support Specialists" ~ "Computer\nNetwork\nSupport\nSpecialists",
                                                                          name == "Electrical and Electronic Engineering Technologists and Technicians" ~ "Electronic\nEngineering\nTechnicians",
                                                                          name == "Information Security Engineers" ~ "Information\nSecurity\nEngineers",
                                                                          name == "Intelligence Analyst" ~ "Intelligence\nAnalyst",
                                                                          name == "Detectives and Criminal Investigators" ~ "Detectives\nand Criminal\nInvestigators",
                                                                          name == "Police Identification and Records Officers" ~ "Police\nIdentification\nand Records\nOfficers"))
```

```{r}
cyber2 <- cyber[!duplicated(cyber[1:2]),]
```

```{r}
cyber[1:2]
```


```{r}
cyber <- cyber[!duplicated(cyber[1:2]),]
```


```{r}
cyber <- cyber %>% select(ONETSOCTITLE, Certification, STW, Origin, Certifier, Level, InDemand)
```

```{r cybernet graph}
g_test <- graph.data.frame(cyber, directed = F, vertices = cybermat_attributes)
V(g_test)$type <- bipartite.mapping(g_test)$type
g_test.pr <- bipartite.projection(g_test)
```

```{r, fig.height = 20, fig.width = 20}
plot(g_test,vertex.shape=ifelse(V(g_test)$type,"circle","square"),
     vertex.color = ifelse(V(g_test)$type == F, ifelse(V(g_test)$STW == "STW", cbPalette[5], cbPalette[1]), cbPalette[3]),
     edge.color = ifelse(E(g_test)$STW == "STW", cbPalette.blk[7], cbPalette[1]),
     vertex.label = ifelse(V(g_test)$type == F, V(g_test)$socname, NA),
     vertex.label.cex = 0.65,
     vertex.label.dist = 0,
     vertex.label.color = "black",
     vertex.size = ifelse(V(g_test)$type, 1.5, 9.3),
     directed = F)
title(main = "Cybersecurity Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("STW", "Non-STW"), col = c(cbPalette[5],cbPalette[1]), pch = 19, pt.cex = 1.5, bty = "n", title = "Type of Occupation", xjust = 0)
legend("bottomleft", legend = c("Credential", "Occupation"), pch = c(19, 15), pt.cex = 1.5, bty = "n", title = "Node Type", inset = c(0, .05), xjust = 0)
```



## Nursing Only


first, subset d and d_attributes

```{r}
nurse <- d[d$SOC == "29-1126" | d$SOC == "29-1292" | d$SOC == "29-2055" | d$SOC == "29-2056" | d$SOC == "29-9093",]
nurse_attr <- d_attributes[d_attributes$SOC == "29-1126" | d_attributes$SOC == "29-1292" | d_attributes$SOC == "29-2055" | d_attributes$SOC == "29-2056" | d_attributes$SOC == "29-9093",]
```

```{r}
nurse_attr <- nurse_attr %>% mutate(socname = case_when(name == "Respiratory Therapists" ~ "Respiratory\nTherapists",
                                                        name == "Dental Hygienists" ~ "Dental\nHygienists",
                                                        name == "Surgical Technologists" ~ "Surgical\nTechnologists",
                                                        name == "Veterinary Technologists and Technicians" ~ "Veterinary\nTechnologists\nand\nTechnicians",
                                                        name == "Surgical Assistants" ~ "Surgical\nAssistants"))
```

```{r}
V(nurse_net)$name[V(nurse_net)$type == F]
```

```{r}
nurse <- nurse[!duplicated(nurse[1:2]),]
```


```{r}
nurse_net <- graph.data.frame(nurse, directed = F, vertices = nurse_attr)
V(nurse_net)$type <- bipartite.mapping(nurse_net)$type
nurse_net.pr <- bipartite.projection(nurse_net)
```

```{r}
#Color Blind Palettes

#color blind palette with grey

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#color blind palette with black

cbPalette.blk<-c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#display the palette

wheel <- function(col, radius = 1, ...)

  pie(rep(1, length(col)), col = col, radius = radius, ...)

wheel(cbPalette)
wheel(cbPalette.blk)
```


#creating a graph of only the nursing credentials

```{r nurse graph, fig.height = 20, fig.width = 20}
plot(nurse_net,
     vertex.shape = ifelse(V(nurse_net)$type, "circle", "square"),
     vertex.color = ifelse(V(nurse_net)$type, cbPalette[4], cbPalette[5]),
     vertex.size = ifelse(V(nurse_net)$type, 5, 15),
     vertex.label = ifelse(V(nurse_net)$type == F, V(nurse_net)$socname, V(nurse_net)$name),
     vertex.label.color = "black",
     vertex.label.dist = ifelse(V(nurse_net)$type, -.75, 0),
     vertex.label.cex = ifelse(V(nurse_net)$type, .75, 1),
     edge.color = cbPalette.blk[1],
     edge.width = 1.5)
title(main = "Nursing Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[4], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
```

```{r}
nurse[nurse$SOCNAME == "Surgical Technologists" & nurse$Certification.Name == "Certified Surgical Assistant",]
```

The reason there are multiple edges between Certified Surgical Assistant and 

## Manufacturing

I made the personal choice to call the manufacturing subset the codes that begin with 17, 19, 27, 49, and 51. I looked up manufacturing occupations on onet and found these in the STW and included the professions within these subsets.  This is a pretty big industry.

Below will include the following occupations:


 
 ^^ narrow this down based on my beliefs of what is in the manufacturing industry, note that, and send to Vicki and Cesar for approval.

making a subset:

```{r}
manufacturing <- d[d$SOC_type == "17" | d$SOC_type == "19" | d$SOC_type == "27" | d$SOC_type == "49" | d$SOC_type == "51",]
manufacturing_attr <- d_attributes[d_attributes$SOC_type == "17" | d_attributes$SOC_type == "19" | d_attributes$SOC_type == "27" | d_attributes$SOC_type == "49" | d_attributes$SOC_type == "51",]
```

```{r}
length(unique(manufacturing$SOCNAME))
```


```{r}
unique(manufacturing$SOC_type)
```

```{r}
added <- manufacturing[(manufacturing$Certification.Name %in% manufacturing_attr$name) == F,]

added <- added %>% select(name = Certification.Name, SOC, SOC_type, Certifying.Organization, Type, GROWTH, PER_CHG)

manufacturing_attr2 <- rbind(manufacturing_attr, added)

manufacturing_attr2 <- manufacturing_attr2[!duplicated(manufacturing_attr2$name),]
```


```{r}
manu_net <- graph.data.frame(manufacturing, directed = F, vertices = manufacturing_attr2)
V(manu_net)$type <- bipartite.mapping(manu_net)$type
manu_net.pr <- bipartite.projection(manu_net)
```

```{r}
unique(V(manu_net)$SOC_type)
```


```{r manufacturing network graph, fig.height = 20, fig.width = 20}
plot(manu_net,
     vertex.size = ifelse(V(manu_net)$type, 2, 4),
     vertex.shape = ifelse(V(manu_net)$type, "circle", "square"),
     vertex.color = ifelse(V(manu_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(manu_net)$type == F, V(manu_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.70,
     edge.width = 2,
     edge.color = "gray")
title(main = "STW Manufacturing Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[6], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
```

```{r}
gsize(manu_net)
vcount(manu_net)
```

621 nodes, 655 edges

```{r}
count_components(manu_net)
```

```{r}
edge_density(manu_net)
```

Not a super dense network

```{r}
transitivity(manu_net, type = "global")
```

Ok so one thing to think about is that we are not going to have triangles, unless we take out the soc codes from this network and look at only the way that the credentials are connected to each other by the SOC codes.  Do we want to have graphs like this?  We are going to have 0 triangles because it is literally impossible for SOC codes or credentials to be connected to one another directly in this graph.




## Repeat the above method to subset to any type of occupation using SOC_type or some other detail



# Entire Network

```{r}
d
```

```{r}

```


```{r, fig.height = 20, fig.width = 20}
growth_color <- as.factor(E(stw_network)$GROWTH)
plot(stw_network,
     vertex.label = ifelse(V(stw_network)$type == F, V(g_test)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     vertex.shape = ifelse(V(stw_network)$type, "circle", "square"),
     vertex.color = ifelse(V(stw_network)$type, cbPalette[8], cbPalette[5]),
     vertex.size = ifelse(V(stw_network)$type, .6, 2),
     edge.width = 2,
     edge.color = ifelse(E(stw_network)$GROWTH == "NEG", cbPalette[7], cbPalette[4]),
     layout = layout_with_kk)
title(main = "STW Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[8], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
legend("bottomleft", legend = c("Positive Projected Growth", "Negative Projected Growth"), col = c(cbPalette[4], cbPalette[7]), pch = c(4,4), pt.cex = 1.5, bty = "n", title = "Edge Type", inset = c(0, .05), xjust = 0)
```

So, we can see that the ones that have a positive projected growth are more connected to one another in the large component, and the ones that are less connected tend to be farther out.

consider how we can make this one interactive^^

```{r}
vcount(stw_network)
```

```{r}
ecount(stw_network)
```


```{r}
head(d)
```

```{r}
E(stw_network)$PER_CHG <- as.factor(E(stw_network)$PER_CHG)
```


```{r}
E(stw_network)$color <- colour_values(E(stw_network)$PER_CHG, palette = "rdylgn")
```


```{r, fig.height = 20, fig.width = 20}
#c_scale <- colorRamp(c('orange','yellow','gray', 'lightblue', 'blue'))
#E(stw_network)$color = apply(c_scale(E(stw_network)$PER_CHG), 1, function(x) rgb(x[1]/255,x[2]/255,x[3]/255) )
plot(stw_network,
     vertex.label = NA,
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     vertex.shape = ifelse(V(stw_network)$type, "circle", "square"),
     vertex.color = ifelse(V(stw_network)$type, cbPalette[8], cbPalette[5]),
     vertex.size = ifelse(V(stw_network)$type, .75, 2),
     edge.width = 2,
     edge.color = E(stw_network)$color,
     layout = layout_with_graphopt)
title(main = "STW Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[8], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
legend("bottomleft", legend = c("Positive Projected Growth", "Negative Projected Growth"), col = c(cbPalette[4], cbPalette[7]), pch = c(4,4), pt.cex = 1.5, bty = "n", title = "Edge Type", inset = c(0, .05), xjust = 0)
```


```{r}
my_palette <- viridis_pal()
```

```{r, fig.height = 20, fig.width = 20}
E(stw_network)$color <- colour_values(E(stw_network)$PER_CHG, palette = "viridis")
plot(stw_network,
     vertex.label = NA,
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     vertex.shape = ifelse(V(stw_network)$type, "circle", "square"),
     vertex.color = ifelse(V(stw_network)$type, cbPalette[8], cbPalette[5]),
     vertex.size = ifelse(V(stw_network)$type, .75, 2),
     edge.width = 2,
     edge.color = E(stw_network)$color,
     layout = layout_with_graphopt)
title(main = "STW Credential and Occupation Network", sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[8], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
legend("bottomleft", legend = c("Positive Projected Growth", "Negative Projected Growth"), col = c(cbPalette[4], cbPalette[7]), pch = c(4,4), pt.cex = 1.5, bty = "n", title = "Edge Type", inset = c(0, .05), xjust = 0)
```

## subsetting to each broad occupation group

```{r temp plot for occ groups, fig.height = 20, fig.width=20}
#Enter the number of the occupation group you'd like to see!
#"11" "13" "15" "17" "19" "27" "29" "33" "35" "43" "47" "49" "51" "53"
temp_net_lab <- "19"
#don't do it for the ones that only have one, 11, 13, 15, 19, 33, 35, 43, 45

#generate the network object for the selected graph

d_temp <- d[d$SOC_type == temp_net_lab,]
d_attr_temp <- d_attributes[d_attributes$SOC_type == temp_net_lab,]

temp_net <- graph.data.frame(d_temp, directed = F, vertices = d_attr_temp)
#43, 47, 49, 51, 53 have some vertex names in edgelist that are not in the vertex dataframe
V(temp_net)$type <- bipartite.mapping(temp_net)$type
temp_net.pr <- bipartite.projection(temp_net)

plot(temp_net,
     vertex.size = ifelse(V(temp_net)$type, 2, 4),
     vertex.shape = ifelse(V(temp_net)$type, "circle", "square"),
     vertex.color = ifelse(V(temp_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(temp_net)$type == F, V(temp_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.70,
     edge.width = 2,
     edge.color = "gray")
title(temp_net_lab, sub = "data from O*Net OnLine")
legend("bottomleft", legend = c("Credential", "Occupation"), col = c(cbPalette[6], cbPalette[5]), pch = c(19,15), pt.cex = 1.5, bty = "n", title = "Node Type", xjust = 0)
```



ideas: make each of these independently, so that if I pick a color for each subgroup, we could maintain those colors in the bigger graph, or draw lines around them too I suppose.
if I make them independently, it will only be a matter of naming them or lumping them together.  Then we could just direct the shiny app to be to the code for that one.
