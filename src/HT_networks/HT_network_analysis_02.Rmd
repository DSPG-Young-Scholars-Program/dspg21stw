---
title: "HT_network_analysis"
author: "Haleigh Tomlin"
date: "7/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(igraph)
library(network)
library(readxl)
library(tidyr)
library(tidyverse)
library(ggplot2)
```


```{r}
#Color Blind Palettes

#color blind palette with grey

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#color blind palette with black

cbPalette.blk<-c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#display the palette

wheel <- function(col, radius = 1, ...)

  pie(rep(1, length(col)), col = col, radius = radius, ...)

wheel(cbPalette)
wheel(cbPalette.blk)
```

```{r, fig.height = 10}
#making a legend with Vicki's code
#install.packages("wesanderson")

library(wesanderson)
png('test.png',width=1000,height=800,units="px",bg = "transparent")

Zissou1<-c("#3B9AB2", "#78B7C5", "#EBCC2A", "#E1AF00", "#F21A00")

WA.pal<-wes_palette("Zissou1", 5, type = c("discrete"))

legend.network<- function(col, radius = 1, ...)

{

pie(rep(1, length(col)), col=col, radius=radius,

labels=c("Decrease\n[-35.7% to -20.0%]", "Decrease\n[-19.9% to -0.2%]", "Increase\n[0.2% to 19.9%]",

"Increase\n[20.0% to 30.5%]", "Increase\n[50.5% to 60.7%]"),

cex=1.2, init.angle=18,

main="Bureau of Labor Statistics: 2019-2029 Employment Projection Categories")

}

legend.network(WA.pal)
plot.background = element_rect(fill = "transparent", color = NA)
```

```{r}
legend.network(WA.pal)
```

```{r}
WA.pal
```


#function for printing network stats

```{r}
get_network_stats <- function(network.obj) {
  net_size <- vcount(network.obj)
  net_dens <- edge_density(network.obj)
  net_comp <- count_components(network.obj)
  net_diam <- diameter(network.obj)
  net_cluster <- transitivity(network.obj)
  return(paste("Size: ", net_size, "Density: ", net_dens, "Number of Components: ", net_comp, "Diameter: ", net_diam, "Clustering Coefficient: ", net_cluster))
}
```


## Making the overall network data and its attributes

```{r}
cert <- read_xlsx("~/dspg21stw/src/ONET_SOC_credentials.xlsx")
stw_change_pct <- read_xlsx("~/dspg21stw/src/STW_2021_Change.xlsx")
```

```{r}
cert <- cert[-1]

stw_change_pct <- stw_change_pct %>% select(SOC, GROWTH, PER_CHG, SOCNAME = NAME)

cert <- cert %>% select(SOC, Certification.Name, Certifying.Organization, Type)

d <- cert %>% left_join(stw_change_pct, by = "SOC")
```



```{r}
d <- d %>% select(SOCNAME, Certification.Name, SOC, Certifying.Organization, Type, GROWTH, PER_CHG)
```


```{r}
d <- d %>% mutate(SOC_type = substr(SOC, start = 1, stop = 2))
```


```{r}
d <- d %>% mutate(soc_type_name = case_when(SOC_type == "11" ~ "Management Occupations",
                                            SOC_type == "13" ~ "Business and Financial Operations Occupations",
                                            SOC_type == "15" ~ "Computer and Mathematical Occupations",
                                            SOC_type == "17" ~ "Architecture and Engineering Occupation",
                                            SOC_type == "19" ~ "Life, Physical, and Social Science Occupations",
                                            SOC_type == "27" ~ "Art, Design, Entertainment, Sports, And Media Occupations",
                                            SOC_type == "29" ~ "Healthcare Practitioners and Technical Occupation",
                                            SOC_type == "35" ~ "Protective Service Occupations",
                                            SOC_type == "43" ~ "Office and Administrative Support Occupations",
                                            SOC_type == "45" ~ "Farming, Fishing, and Forestry Occupations",
                                            SOC_type == "47" ~ "Construction and Extraction Occupations",
                                            SOC_type == "49" ~ "Installation, Maintenance, and Repair Occupations",
                                            SOC_type == "51" ~ "Production Occupations",
                                            SOC_type == "53" ~ "Transportation and Material Moving Occupations"))
```


```{r}
d <- d %>% mutate(soc_type_name = gsub(" ", "\n", soc_type_name),
                  SOCNAME = gsub(" ", "\n", SOCNAME))
```


^^ use this as the original df.  An attributes matrix now:


labels=c("Decrease\n[-35.7% to -20.0%]", "Decrease\n[-19.9% to -0.2%]", "Increase\n[0.2% to 19.9%]",

"Increase\n[20.0% to 30.5%]", "Increase\n[50.5% to 60.7%]")

```{r}
d <- d %>% mutate(PER_CHG_CAT = case_when(PER_CHG <= -20.0 ~ "highly decreasing",
                                          PER_CHG > -20.0 & PER_CHG <= -0.2 ~ "decreasing",
                                          PER_CHG > -0.2 & PER_CHG <= 19.9 ~ "increasing",
                                          PER_CHG > 19.9 & PER_CHG <= 30.5 ~ "highly increasing",
                                          PER_CHG > 30.5 ~ "very highly increasing"))

```

```{r}
d$PER_CHG_CAT <- as.factor(d$PER_CHG_CAT)
levels(d$PER_CHG_CAT) <- c("highly decreasing", "decreasing", "increasing", "highly increasing", "very highly increasing")
```

```{r}
d_attributes1 <- d %>% select(name = SOCNAME, SOC, SOC_type, Certifying.Organization, SOC_type, soc_type_name, GROWTH, PER_CHG_CAT)
d_attributes2 <- d %>% select(name = Certification.Name, SOC, SOC_type, Certifying.Organization, SOC_type, soc_type_name, GROWTH, PER_CHG_CAT)

d_attributes1 <- d_attributes1[!duplicated(d_attributes1$name),]
d_attributes2 <- d_attributes2[!duplicated(d_attributes2$name),]

d_attributes <- rbind(d_attributes1, d_attributes2)

d <- d %>% select(-c(Type, Certifying.Organization))

d <- d[!duplicated(d),]
```


```{r}
ggplot(d, aes(PER_CHG_CAT)) + geom_bar(fill = WA.pal[5])
```


```{r}
range(as.numeric(d$PER_CHG), na.rm = T)
```


```{r}
stw_network <- graph.data.frame(d, directed = F, vertices = d_attributes)
V(stw_network)$type <- bipartite.mapping(stw_network)$type
stw_network.pr <- bipartite.projection(stw_network)
```





# Entire Network

```{r}
d
```


```{r}
d_attributes
```
legend("bottomright", legend = c("11: Management", "13: Business and Financial Operations", "17: Archictecture and Engineering", "19: Life, Physical, and Social Science", "27: Art, Design, Entertainment, Sports, and Media", "29: Healthcare Practitioners and Technical Occupations", "33: Protective Service", "35: Food Preparation and Serving", "43: Office and Administrative Support", "45: Farming, Fishing, and Forestry", "47: Construction and Extraction", "49: Installation, Maintenance, and Repair", "51: Production Occupations", "53: Transportation and Material Moving"), bty = "n", title = "SOC Major Occupation Groups", xjust = 1, cex = 1.5)

```{r, fig.height = 40, fig.width = 40}
#E(stw_network)$color <- colour_values(E(stw_network)$PER_CHG_CAT, palette = WA.pal)
E(stw_network)$color <- ifelse(E(stw_network)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(stw_network)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(stw_network)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(stw_network,
     vertex.label = ifelse(V(stw_network)$type, NA, V(stw_network)$SOC_type),
     vertex.label.color = "black",
     vertex.label.cex = 1.4,
     vertex.shape = ifelse(V(stw_network)$type, "circle", "square"),
     vertex.color = ifelse(V(stw_network)$type, cbPalette[8], cbPalette[5]),
     vertex.size = ifelse(V(stw_network)$type, 1, 5),
     edge.width = 2,
     edge.color = E(stw_network)$color,
     layout = layout_with_dh)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: pink circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
legend("bottomright", legend = c("11: Management", "13: Business and Financial Operations", "17: Archictecture and Engineering", "19: Life, Physical, and Social Science", "27: Art, Design, Entertainment, Sports, and Media", "29: Healthcare Practitioners and Technical Occupations", "33: Protective Service", "35: Food Preparation and Serving", "43: Office and Administrative Support", "45: Farming, Fishing, and Forestry", "47: Construction and Extraction", "49: Installation, Maintenance, and Repair", "51: Production Occupations", "53: Transportation and Material Moving"), bty = "n", title = "SOC Major Occupation Groups", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(stw_network)
```


## subsetting to each broad occupation group

#Already did it for Healthcare Practitioners and Technical Occupations, Art, Design, Entertainment, Sports, and Media Occupations, Architechture and Engineering Occupations

```{r}
unique(d$soc_type_name)
```

#Art, Design Entertainment, Sports and Media Occupations

```{r}
d_art<- d[d$soc_type_name == "Art,\nDesign,\nEntertainment,\nSports,\nAnd\nMedia\nOccupations",]
#d_arch <- na.omit(d_repair)
```


```{r}
#d_art <- d_art %>% select(-Type)
d_art <- na.omit(d_art)
d_art <- d_art[!duplicated(d_art),]
art <- graph.data.frame(d_art)


nodelist <- data.frame(name = igraph::V(art)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

art_net <- graph.data.frame(d_art, directed = F, vertices = nodelist)
V(art_net)$type <- bipartite.mapping(art_net)$type
```

```{r, fig.height = 25, fig.width= 25}
E(art_net)$color <- ifelse(E(art_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(arch_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(art_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(art_net,
     vertex.size = ifelse(V(art_net)$type, 2, 9),
     vertex.shape = ifelse(V(art_net)$type, "circle", "square"),
     vertex.color = ifelse(V(art_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(art_net)$type == F, V(art_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.6,
     edge.width = 2,
     edge.color = E(art_net)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(art_net)
```


#Architecture and Engineering

```{r}
d_arch<- d[d$soc_type_name == "Architecture\nand\nEngineering\nOccupation",]
#d_arch <- na.omit(d_repair)
```


```{r}
#d_arch <- d_arch %>% select(-Type)
d_arch <- na.omit(d_arch)
d_arch <- d_arch[!duplicated(d_arch),]
arch <- graph.data.frame(d_arch)


nodelist <- data.frame(name = igraph::V(arch)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

arch_net <- graph.data.frame(d_arch, directed = F, vertices = nodelist)
V(arch_net)$type <- bipartite.mapping(arch_net)$type
```


```{r}
nodelist
d_arch
```


```{r}
d_arch[d_arch$SOCNAME == "Surveying\n&\nMapping\nTechnicians",]
table(duplicated(d_arch))
```


```{r, fig.height = 25, fig.width= 25}
E(arch_net)$color <- ifelse(E(arch_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(arch_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(arch_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(arch_net,
     vertex.size = ifelse(V(arch_net)$type, 2, 9),
     vertex.shape = ifelse(V(arch_net)$type, "circle", "square"),
     vertex.color = ifelse(V(arch_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(arch_net)$type == F, V(arch_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     edge.width = 2,
     edge.color = E(arch_net)$color,
     layout = layout_with_dh)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(arch_net)
```


#"Healthcare\nPractitioners\nand\nTechnical\nOccupation"

```{r}
d_health <- d[d$soc_type_name == "Healthcare\nPractitioners\nand\nTechnical\nOccupation",]
#d_health <- d_health %>% select(-c(Type, Certifying.Organization))
d_health <- d_health[!duplicated(d_health),]

d_health <- na.omit(d_health)

```

```{r}
hlth <- graph.data.frame(d_health)


nodelist <- data.frame(name = igraph::V(hlth)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

health_net <- graph.data.frame(d_health, directed = F, vertices = nodelist)
V(health_net)$type <- bipartite.mapping(health_net)$type
```

```{r, fig.height = 20, fig.width= 20}
E(health_net)$color <- ifelse(E(health_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(const_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(health_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(health_net,
     vertex.size = ifelse(V(health_net)$type, 2, 10),
     vertex.shape = ifelse(V(health_net)$type, "circle", "square"),
     vertex.color = ifelse(V(health_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(health_net)$type == F, V(const_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     edge.width = 2,
     edge.color = E(health_net)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(health_net)
```


#Construction and Extraction Occupations

```{r}
d_const <- d[d$soc_type_name == "Construction\nand\nExtraction\nOccupations",]
#d_const <- d_const %>% select(-c(Type, Certifying.Organization))
d_const <- d_const[!duplicated(d_const),]

d_const <- na.omit(d_const)

```

```{r}
d_const
```


```{r}
const <- graph.data.frame(d_const)


nodelist <- data.frame(name = igraph::V(const)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

const_net <- graph.data.frame(d_const, directed = F, vertices = nodelist)
V(const_net)$type <- bipartite.mapping(const_net)$type
```


```{r, fig.height = 20, fig.width= 20}
E(const_net)$color <- ifelse(E(const_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(const_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(const_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(const_net,
     vertex.size = ifelse(V(const_net)$type, 2, 12),
     vertex.shape = ifelse(V(const_net)$type, "circle", "square"),
     vertex.color = ifelse(V(const_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(const_net)$type == F, V(const_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     edge.width = 2,
     edge.color = E(const_net)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(const)
```


#Installation, Maintenance, and Repair Occupations

```{r}
d_repair<- d[d$soc_type_name == "Installation,\nMaintenance,\nand\nRepair\nOccupations",]
d_repair <- na.omit(d_repair)
```

```{r}
#d_repair <- d_repair %>% select(-Type)
d_repair <- d_repair[!duplicated(d_repair),]
```


```{r}
rep <- graph.data.frame(d_repair)

nodelist <- data.frame(name = igraph::V(rep)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

rep_net <- graph.data.frame(d_repair, directed = F, vertices = nodelist)
V(rep_net)$type <- bipartite.mapping(rep_net)$type
```

```{r, fig.height = 20, fig.width=20}
E(rep_net)$color <- ifelse(E(rep_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(rep_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(rep_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(rep_net,
     vertex.size = ifelse(V(rep_net)$type, 2, 13),
     vertex.shape = ifelse(V(rep_net)$type, "circle", "square"),
     vertex.color = ifelse(V(rep_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(rep_net)$type == F, V(rep_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.6,
     edge.width = 2,
     #edge.color = E(prod)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(rep)
```


```{r}
d_repair
```


# "Production\nOccupations"

```{r}
d_prod <- d[d$soc_type_name == "Production\nOccupations",]
d_prod <- na.omit(d_prod)
d_prod_attr <- d_attributes[d_attributes$soc_type_name == "Production\nOccupations",]
#d_prod <- d_prod %>% select(-c(Type, Certifying.Organization))
d_prod <- d_prod[!duplicated(d_prod),]
```

```{r}
prod <- graph.data.frame(d_prod)
#prod <- na.omit(prod)
#d_prod_attr <- na.omit(d_prod_attr)
```

```{r}
nodelist <- data.frame(name = igraph::V(prod)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

```

```{r}
prod <- graph.data.frame(d_prod, directed = F, vertices = nodelist)
V(prod)$type <- bipartite.mapping(prod)$type
```


```{r, fig.height = 20, fig.width=20}
E(prod)$color <- ifelse(E(prod)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(prod)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(prod)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(prod,
     vertex.size = ifelse(V(prod)$type, 2, 15),
     vertex.shape = ifelse(V(prod)$type, "circle", "square"),
     vertex.color = ifelse(V(prod)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(prod)$type == F, V(prod)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.6,
     edge.width = 2,
     edge.color = E(prod)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(prod)
```


#"Transportation\nand\nMaterial\nMoving\nOccupations"

```{r}
d_transport <- d[d$soc_type_name == "Transportation\nand\nMaterial\nMoving\nOccupations",]
d_transport <- na.omit(d_transport)
```

```{r}
trans <- graph.data.frame(d_transport)

nodelist <- data.frame(name = igraph::V(trans)$name)

nodelist <- nodelist %>% left_join(d_attributes, by = "name")

trans_net <- graph.data.frame(d_transport, directed = F, vertices = nodelist)
V(trans_net)$type <- bipartite.mapping(trans_net)$type
```

```{r, fig.height = 20, fig.width=20}
E(trans_net)$color <- ifelse(E(trans_net)$PER_CHG_CAT == "highly decreasing", WA.pal[1], ifelse(E(trans_net)$PER_CHG_CAT == "decreasing", WA.pal[2], ifelse(E(trans_net)$PER_CHG_CAT == "increasing", WA.pal[3], WA.pal[4])))
plot(trans_net,
     vertex.size = ifelse(V(trans_net)$type, 2, 10),
     vertex.shape = ifelse(V(trans_net)$type, "circle", "square"),
     vertex.color = ifelse(V(trans_net)$type, cbPalette[6], cbPalette[5]),
     #vertex.color = cbPalette[V(manu_net)$SOC_type],
     vertex.label = ifelse(V(trans_net)$type == F, V(trans_net)$name, NA),
     vertex.label.color = "black",
     vertex.label.cex = 0.6,
     edge.width = 2,
     edge.color = E(trans_net)$color,
     layout = layout_nicely)
legend("topright", legend = c("STW Occupations: yellow squares", "Certifications: blue circles"), bty = "n", title = "Legend", xjust = 1, cex = 1.5)
```

```{r}
get_network_stats(trans_net)
```




